---
title: "Flink Kafka MySQL æŸ¥æ‰¾è¿æ¥å®æˆ˜ï¼šå®æ—¶æ•°æ®ä¸°å¯Œçš„æœ€ä½³å®è·µ"
description: "è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ PyFlink å®ç° Kafka + MySQL çš„æŸ¥æ‰¾è¿æ¥ï¼Œå®ç° IoT è®¾å¤‡æ•°æ®çš„å®æ—¶å…ƒæ•°æ®ä¸°å¯Œï¼ŒåŒ…å«å®Œæ•´çš„å®æˆ˜ä»£ç å’Œæœ€ä½³å®è·µ"
date: 2024-06-23T10:00:00+08:00
draft: false
tags: ["Flink", "PyFlink", "Kafka", "MySQL", "å®æ—¶æ•°æ®å¤„ç†", "æŸ¥æ‰¾è¿æ¥", "IoT"]
categories: ["å®æ—¶æ•°æ®å¤„ç†", "Apache Flink"]
weight: 1
ShowToc: true
TocOpen: true
---

## ğŸ“‹ ç›®å½•

- [ğŸ“‹ ç›®å½•](#-ç›®å½•)
- [ğŸ“– æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ¯ æœ¬æ–‡ç‰¹ç‚¹](#-æœ¬æ–‡ç‰¹ç‚¹)
- [ğŸ—ï¸ æŠ€æœ¯æ¶æ„](#ï¸-æŠ€æœ¯æ¶æ„)
  - [ğŸ§© æ ¸å¿ƒç»„ä»¶](#-æ ¸å¿ƒç»„ä»¶)
  - [ğŸ”„ æ•°æ®æµè½¬è¿‡ç¨‹](#-æ•°æ®æµè½¬è¿‡ç¨‹)
  - [ç³»ç»Ÿæ¶æ„å›¾](#ç³»ç»Ÿæ¶æ„å›¾)
- [âš™ï¸ å®ç°ç»†èŠ‚](#ï¸-å®ç°ç»†èŠ‚)
  - [1ï¸âƒ£ ç¯å¢ƒé…ç½®](#1ï¸âƒ£-ç¯å¢ƒé…ç½®)
  - [2ï¸âƒ£ æ•°æ®æºå®šä¹‰](#2ï¸âƒ£-æ•°æ®æºå®šä¹‰)
    - [ğŸ“¡ Kafka æºè¡¨](#-kafka-æºè¡¨)
    - [ğŸ—„ï¸ MySQL ç»´åº¦è¡¨](#ï¸-mysql-ç»´åº¦è¡¨)
  - [3ï¸âƒ£ æŸ¥æ‰¾è¿æ¥å®ç°](#3ï¸âƒ£-æŸ¥æ‰¾è¿æ¥å®ç°)
  - [æ•°æ®å­—æ®µæµè½¬å›¾](#æ•°æ®å­—æ®µæµè½¬å›¾)
  - [å¤„ç†æµç¨‹æ—¶åºå›¾](#å¤„ç†æµç¨‹æ—¶åºå›¾)
- [ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
  - [ä¼˜åŒ–ç­–ç•¥æ€»è§ˆ](#ä¼˜åŒ–ç­–ç•¥æ€»è§ˆ)
  - [1ï¸âƒ£ æŸ¥æ‰¾è¿æ¥ç¼“å­˜](#1ï¸âƒ£-æŸ¥æ‰¾è¿æ¥ç¼“å­˜)
  - [2ï¸âƒ£ æ£€æŸ¥ç‚¹é…ç½®](#2ï¸âƒ£-æ£€æŸ¥ç‚¹é…ç½®)
  - [3ï¸âƒ£ å¹¶è¡Œåº¦è®¾ç½®](#3ï¸âƒ£-å¹¶è¡Œåº¦è®¾ç½®)
- [ğŸ“Š ç›‘æ§ä¸è°ƒè¯•](#-ç›‘æ§ä¸è°ƒè¯•)
  - [1ï¸âƒ£ Print Sink è°ƒè¯•](#1ï¸âƒ£-print-sink-è°ƒè¯•)
  - [2ï¸âƒ£ æ•°æ®è´¨é‡ç›‘æ§](#2ï¸âƒ£-æ•°æ®è´¨é‡ç›‘æ§)
- [ğŸš€ éƒ¨ç½²æ–¹å¼](#-éƒ¨ç½²æ–¹å¼)
  - [1ï¸âƒ£ é›†ç¾¤éƒ¨ç½²](#1ï¸âƒ£-é›†ç¾¤éƒ¨ç½²)
  - [2ï¸âƒ£ æœ¬åœ°è°ƒè¯•](#2ï¸âƒ£-æœ¬åœ°è°ƒè¯•)
- [ğŸ¯ æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)
  - [1ï¸âƒ£ æ•°æ®è´¨é‡ä¿è¯](#1ï¸âƒ£-æ•°æ®è´¨é‡ä¿è¯)
  - [2ï¸âƒ£ å®¹é”™è®¾è®¡](#2ï¸âƒ£-å®¹é”™è®¾è®¡)
  - [3ï¸âƒ£ æ€§èƒ½è°ƒä¼˜](#3ï¸âƒ£-æ€§èƒ½è°ƒä¼˜)
- [ğŸŒŸ åº”ç”¨åœºæ™¯](#-åº”ç”¨åœºæ™¯)
- [ğŸ‰ æ€»ç»“](#-æ€»ç»“)
  - [ğŸ† å…³é”®æ”¶ç›Š](#-å…³é”®æ”¶ç›Š)
  - [ğŸš€ é€‚ç”¨æ€§](#-é€‚ç”¨æ€§)

---

## ğŸ“– æ¦‚è¿°

åœ¨å®æ—¶æ•°æ®å¤„ç†åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦å°†æµå¼æ•°æ®ä¸ç»´åº¦æ•°æ®è¿›è¡Œå…³è”ï¼Œä»¥ä¸°å¯ŒåŸå§‹æ•°æ®ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ PyFlink å®ç° Kafka + MySQL çš„æŸ¥æ‰¾è¿æ¥ï¼ˆLookup Joinï¼‰ï¼Œä»è€Œå®ç° IoT è®¾å¤‡æ•°æ®çš„å®æ—¶å…ƒæ•°æ®ä¸°å¯Œã€‚

### ğŸ¯ æœ¬æ–‡ç‰¹ç‚¹

- **å®æˆ˜å¯¼å‘**ï¼šåŸºäºçœŸå®çš„ç”Ÿäº§ç¯å¢ƒä»£ç 
- **å›¾æ–‡å¹¶èŒ‚**ï¼šåŒ…å«å®Œæ•´çš„ Mermaid å¯è§†åŒ–å›¾è¡¨
- **æœ€ä½³å®è·µ**ï¼šæ¶µç›–æ€§èƒ½ä¼˜åŒ–ã€ç›‘æ§è°ƒè¯•ã€å®¹é”™è®¾è®¡
- **ç«¯åˆ°ç«¯**ï¼šä»æ•°æ®æºåˆ°è¾“å‡ºçš„å®Œæ•´æ–¹æ¡ˆ

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### ğŸ§© æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | æè¿° | ä½œç”¨ |
|------|------|------|
| ğŸ“¡ **Kafka Source** | `iot-topic` | å­˜å‚¨åŸå§‹ IoT è®¾å¤‡æ•°æ® |
| ğŸ—„ï¸ **MySQL ç»´åº¦è¡¨** | `meta_data` | å­˜å‚¨è®¾å¤‡å…ƒæ•°æ®ä¿¡æ¯ |
| ğŸ” **Apache Flink** | PyFlink | å®ç°å®æ—¶æµå¤„ç†å’ŒæŸ¥æ‰¾è¿æ¥ |
| ğŸ–¥ï¸ **Print Sink** | è°ƒè¯•è¾“å‡º | ç”¨äºè°ƒè¯•å’Œç›‘æ§ |
| ğŸ“¡ **Kafka Sink** | `rich-iot-data` | å­˜å‚¨ä¸°å¯Œåçš„æ•°æ® |

### ğŸ”„ æ•°æ®æµè½¬è¿‡ç¨‹

| æ­¥éª¤ | æ“ä½œ | æè¿° |
|------|------|------|
| 1ï¸âƒ£ | **æ•°æ®æ‘„å–** | ä» Kafka `iot-topic` è¯»å–åŸå§‹ IoT æ•°æ® |
| 2ï¸âƒ£ | **æŸ¥æ‰¾è¿æ¥** | åŸºäº `pboxid` å­—æ®µæŸ¥æ‰¾ MySQL ä¸­çš„è®¾å¤‡å…ƒæ•°æ® |
| 3ï¸âƒ£ | **æ•°æ®ä¸°å¯Œ** | å°†åŸå§‹æ•°æ®ä¸å…ƒæ•°æ®åˆå¹¶ |
| 4ï¸âƒ£ | **æ•°æ®è¾“å‡º** | åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œ Kafka `rich-iot-data` topic |

### ç³»ç»Ÿæ¶æ„å›¾

ä¸Šè¿°æµç¨‹çš„æ•´ä½“æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå±•ç¤ºäº†ä»æ•°æ®æºåˆ°è¾“å‡ºçš„å®Œæ•´é“¾è·¯ï¼š

```mermaid
graph TD
    A["ğŸ“± IoT è®¾å¤‡"] --> B["ğŸ“¡ Kafka Topic<br/>(iot-topic)"]
    B --> C["ğŸ” Flink Stream Processing<br/>PyFlink Application"]
    
    D["ğŸ—„ï¸ MySQL Database<br/>(meta_data table)"] --> E["ğŸ“‹ MySQL ç»´åº¦è¡¨<br/>(Lookup Table)"]
    E --> C
    
    C --> F["ğŸ”— æŸ¥æ‰¾è¿æ¥<br/>(Lookup Join)"]
    F --> G["ğŸ“Š æ•°æ®ä¸°å¯Œ<br/>(Enriched Data)"]
    
    G --> H["ğŸ–¥ï¸ Print Sink<br/>(Debug Console)"]
    G --> I["ğŸ“¡ Kafka Topic<br/>(rich-iot-data)"]
    
    J["âš™ï¸ Flink æ£€æŸ¥ç‚¹<br/>(Checkpointing)"] -.-> C
    K["ğŸ“ çŠ¶æ€ç®¡ç†<br/>(State Backend)"] -.-> C
    
    subgraph "æ•°æ®æº"
        A
        B
        D
    end
    
    subgraph "å¤„ç†å±‚"
        C
        E
        F
        G
    end
    
    subgraph "è¾“å‡ºå±‚"
        H
        I
    end
    
    subgraph "å®¹é”™æœºåˆ¶"
        J
        K
    end
```

---

## âš™ï¸ å®ç°ç»†èŠ‚

### 1ï¸âƒ£ ç¯å¢ƒé…ç½®

```python
def _create_table_environment_with_checkpointing():
    """åˆ›å»º Table ç¯å¢ƒå¹¶é…ç½®æ£€æŸ¥ç‚¹"""
    env = StreamExecutionEnvironment.get_execution_environment()
    env.set_parallelism(1)
    
    # é…ç½®æ£€æŸ¥ç‚¹ï¼Œç¡®ä¿ Exactly-Once è¯­ä¹‰
    env.enable_checkpointing(10000)  # æ¯10ç§’è§¦å‘ä¸€æ¬¡æ£€æŸ¥ç‚¹
    env.get_checkpoint_config().set_checkpointing_mode(CheckpointingMode.EXACTLY_ONCE)
    
    # åˆ›å»ºæµå¼ Table ç¯å¢ƒ
    settings = EnvironmentSettings.new_instance().in_streaming_mode().build()
    table_env = TableEnvironment.create(settings)
    
    return table_env
```

**å…³é”®é…ç½®è¯´æ˜**:
- **æ£€æŸ¥ç‚¹é—´éš”**: 10ç§’ï¼Œç¡®ä¿å®¹é”™æ€§
- **è¯­ä¹‰ä¿è¯**: EXACTLY_ONCEï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- **æ—¶åŒºè®¾ç½®**: Asia/Shanghaiï¼Œå¤„ç†æ—¶é—´æœ¬åœ°åŒ–
- **çŠ¶æ€ä¿ç•™**: 1å¤©ï¼Œå¹³è¡¡æ€§èƒ½ä¸èµ„æº

### 2ï¸âƒ£ æ•°æ®æºå®šä¹‰

#### ğŸ“¡ Kafka æºè¡¨
```sql
CREATE TABLE iot_source_fixed (
    `pboxid` STRING COMMENT 'è®¾å¤‡å”¯ä¸€æ ‡è¯†',
    `eventTime` STRING COMMENT 'äº‹ä»¶æ—¶é—´å­—ç¬¦ä¸²',
    `metric` DECIMAL(10,2) COMMENT 'æµ‹é‡å€¼',
    `latitude` DECIMAL(10,7) COMMENT 'çº¬åº¦',
    `longitude` DECIMAL(10,7) COMMENT 'ç»åº¦',
    `proc_time` AS PROCTIME() COMMENT 'å¤„ç†æ—¶é—´'
) WITH (
    'connector' = 'kafka',
    'topic' = 'iot-topic',
    'properties.bootstrap.servers' = 'localhost:9092',
    'properties.group.id' = 'lookup-test-group-fixed',
    'scan.startup.mode' = 'group-offsets',
    'properties.auto.offset.reset' = 'latest',
    'format' = 'json'
)
```

#### ğŸ—„ï¸ MySQL ç»´åº¦è¡¨
```sql
CREATE TABLE meta_data_dim_fixed (
    `pboxid` STRING PRIMARY KEY NOT ENFORCED COMMENT 'è®¾å¤‡å”¯ä¸€æ ‡è¯†',
    `device_id` STRING COMMENT 'è®¾å¤‡ID',
    `bind_time` TIMESTAMP(3) COMMENT 'ç»‘å®šæ—¶é—´',
    `unbind_time` TIMESTAMP(3) COMMENT 'è§£ç»‘æ—¶é—´',
    `credit_code` STRING COMMENT 'ä¿¡ç”¨ä»£ç ',
    `status` INT COMMENT 'çŠ¶æ€ï¼š1-æ­£å¸¸ï¼Œ0-ç¦ç”¨'
) WITH (
    'connector' = 'jdbc',
    'url' = 'jdbc:mysql://localhost:3306/testdb',
    'table-name' = 'meta_data',
    'lookup.cache.max-rows' = '1000',
    'lookup.cache.ttl' = '5min',
    'lookup.max-retries' = '3'
)
```

**æŸ¥æ‰¾è¿æ¥ä¼˜åŒ–é…ç½®**:
- **ç¼“å­˜è¡Œæ•°**: 1000è¡Œï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
- **ç¼“å­˜TTL**: 5åˆ†é’Ÿï¼Œå¹³è¡¡æ•°æ®æ–°é²œåº¦ä¸æ€§èƒ½
- **é‡è¯•æ¬¡æ•°**: 3æ¬¡ï¼Œæé«˜å®¹é”™æ€§

### 3ï¸âƒ£ æŸ¥æ‰¾è¿æ¥å®ç°

```sql
CREATE TEMPORARY VIEW enriched_iot_data AS
SELECT 
    i.pboxid,
    i.eventTime,
    i.metric,
    i.latitude,
    i.longitude,
    COALESCE(m.device_id, 'UNKNOWN') as device_id,
    COALESCE(m.credit_code, 'UNKNOWN') as credit_code,
    COALESCE(CAST(m.bind_time AS STRING), '') as bind_time,
    COALESCE(m.status, 0) as status
FROM iot_source_fixed i
LEFT JOIN meta_data_dim_fixed FOR SYSTEM_TIME AS OF i.proc_time AS m
ON i.pboxid = m.pboxid
WHERE i.pboxid IS NOT NULL 
  AND i.latitude BETWEEN -90 AND 90
  AND i.longitude BETWEEN -180 AND 180
  AND i.metric >= 0
```

**å…³é”®ç‰¹æ€§**:
- **æ—¶é—´è¯­ä¹‰**: `FOR SYSTEM_TIME AS OF` ç¡®ä¿æŸ¥æ‰¾è¿æ¥çš„æ—¶é—´ä¸€è‡´æ€§
- **ç©ºå€¼å¤„ç†**: ä½¿ç”¨ `COALESCE` æä¾›é»˜è®¤å€¼
- **æ•°æ®è´¨é‡**: éªŒè¯ç»çº¬åº¦èŒƒå›´å’Œæµ‹é‡å€¼æœ‰æ•ˆæ€§

### æ•°æ®å­—æ®µæµè½¬å›¾

ä¸‹å›¾è¯¦ç»†å±•ç¤ºäº†æ•°æ®ä»è¾“å…¥åˆ°è¾“å‡ºçš„å­—æ®µæ˜ å°„å…³ç³»ï¼š

```mermaid
graph LR
    A["ğŸ“¡ Kafka Source<br/>iot-topic"] --> B["ğŸ”„ Flink Processor"]
    C["ğŸ—„ï¸ MySQL Dimension<br/>meta_data"] --> B
    
    B --> D["ğŸ“Š Enriched Output"]
    D --> E["ğŸ–¥ï¸ Print Sink"]
    D --> F["ğŸ“¡ Kafka Sink<br/>rich-iot-data"]
    
    subgraph "è¾“å…¥æ•°æ®å­—æ®µ"
        A1["â€¢ pboxid (è®¾å¤‡ID)<br/>â€¢ eventTime (äº‹ä»¶æ—¶é—´)<br/>â€¢ metric (æµ‹é‡å€¼)<br/>â€¢ latitude (çº¬åº¦)<br/>â€¢ longitude (ç»åº¦)"]
    end
    
    subgraph "ç»´åº¦æ•°æ®å­—æ®µ"
        C1["â€¢ pboxid (ä¸»é”®)<br/>â€¢ device_id (è®¾å¤‡ID)<br/>â€¢ bind_time (ç»‘å®šæ—¶é—´)<br/>â€¢ credit_code (ä¿¡ç”¨ä»£ç )<br/>â€¢ status (çŠ¶æ€)"]
    end
    
    subgraph "è¾“å‡ºæ•°æ®å­—æ®µ"
        D1["åŸå§‹å­—æ®µ:<br/>â€¢ pboxid<br/>â€¢ eventTime<br/>â€¢ metric<br/>â€¢ latitude<br/>â€¢ longitude<br/><br/>ä¸°å¯Œå­—æ®µ:<br/>â€¢ device_id<br/>â€¢ credit_code<br/>â€¢ bind_time<br/>â€¢ status"]
    end
    
    A --> A1
    C --> C1
    D --> D1
    
    subgraph "Join æ¡ä»¶"
        G["LEFT JOIN ON<br/>i.pboxid = m.pboxid<br/>FOR SYSTEM_TIME AS OF<br/>i.proc_time"]
    end
    
    B --> G
```

### å¤„ç†æµç¨‹æ—¶åºå›¾

ä¸‹å›¾å±•ç¤ºäº†å®æ—¶å¤„ç†çš„è¯¦ç»†æ—¶åºæ­¥éª¤ï¼š

```mermaid
sequenceDiagram
    participant IoT as ğŸ“± IoTè®¾å¤‡
    participant KafkaIn as ğŸ“¡ Kafka(iot-topic)
    participant Flink as ğŸ” Flinkå¤„ç†å™¨
    participant MySQL as ğŸ—„ï¸ MySQL(meta_data)
    participant PrintSink as ğŸ–¥ï¸ Printæ§åˆ¶å°
    participant KafkaOut as ğŸ“¡ Kafka(rich-iot-data)
    
    IoT->>KafkaIn: å‘é€IoTæ•°æ®<br/>(pboxid, eventTime, metric, lat, lon)
    
    loop å®æ—¶å¤„ç†å¾ªç¯
        KafkaIn->>Flink: è¯»å–æµæ•°æ®
        
        Note over Flink: æ•°æ®è´¨é‡éªŒè¯<br/>â€¢ æ£€æŸ¥å¿…å¡«å­—æ®µ<br/>â€¢ éªŒè¯ç»çº¬åº¦èŒƒå›´<br/>â€¢ éªŒè¯metricå€¼
        
        Flink->>MySQL: æŸ¥æ‰¾è¿æ¥æŸ¥è¯¢<br/>(åŸºäºpboxid)
        
        alt æŸ¥æ‰¾æˆåŠŸ
            MySQL-->>Flink: è¿”å›å…ƒæ•°æ®<br/>(device_id, credit_code, bind_time, status)
            Note over Flink: æ•°æ®ä¸°å¯Œ<br/>åˆå¹¶åŸå§‹æ•°æ®å’Œå…ƒæ•°æ®
        else æŸ¥æ‰¾å¤±è´¥
            Note over Flink: ä½¿ç”¨é»˜è®¤å€¼<br/>(UNKNOWN, 0ç­‰)
        end
        
        par å¹¶è¡Œè¾“å‡º
            Flink->>PrintSink: è¾“å‡ºè°ƒè¯•ä¿¡æ¯
        and
            Flink->>KafkaOut: å‘é€ä¸°å¯Œæ•°æ®
        end
        
    end
    
    Note over Flink: æ£€æŸ¥ç‚¹æœºåˆ¶<br/>æ¯10ç§’ä¿å­˜çŠ¶æ€<br/>EXACTLY_ONCEè¯­ä¹‰
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ä¼˜åŒ–ç­–ç•¥æ€»è§ˆ

ä¸‹å›¾å±•ç¤ºäº†æŸ¥æ‰¾è¿æ¥çš„å®Œæ•´ä¼˜åŒ–ç­–ç•¥ï¼ŒåŒ…æ‹¬ç¼“å­˜ã€é‡è¯•ã€æ€§èƒ½è°ƒä¼˜å’Œç›‘æ§ç­‰å¤šä¸ªç»´åº¦ï¼š

```mermaid
graph TB
    A["ğŸ” æŸ¥æ‰¾è¿æ¥ä¼˜åŒ–ç­–ç•¥"] --> B["ğŸ’¾ ç¼“å­˜ç­–ç•¥"]
    A --> C["ğŸ”„ é‡è¯•æœºåˆ¶"]
    A --> D["âš¡ æ€§èƒ½è°ƒä¼˜"]
    A --> E["ğŸ“Š ç›‘æ§å‘Šè­¦"]
    
    B --> B1["ç¼“å­˜å¤§å°: 1000è¡Œ"]
    B --> B2["TTL: 5åˆ†é’Ÿ"]
    B --> B3["ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§"]
    
    C --> C1["æœ€å¤§é‡è¯•: 3æ¬¡"]
    C --> C2["æŒ‡æ•°é€€é¿ç­–ç•¥"]
    C --> C3["è¶…æ—¶å¤„ç†"]
    
    D --> D1["å¹¶è¡Œåº¦è°ƒæ•´"]
    D --> D2["æ‰¹å¤„ç†å¤§å°"]
    D --> D3["è¿æ¥æ± é…ç½®"]
    
    E --> E1["æŸ¥æ‰¾å»¶è¿Ÿç›‘æ§"]
    E --> E2["ç¼“å­˜å‘½ä¸­ç‡"]
    E --> E3["é”™è¯¯ç‡å‘Šè­¦"]
    
    subgraph "ç¼“å­˜å±‚"
        F["Local Cache"] --> G["Remote Cache"]
        G --> H["Database"]
    end
    
    subgraph "å®¹é”™æœºåˆ¶"
        I["æ£€æŸ¥ç‚¹"] --> J["çŠ¶æ€æ¢å¤"]
        J --> K["æ•…éšœè½¬ç§»"]
    end
    
    B --> F
    C --> I
```

### 1ï¸âƒ£ æŸ¥æ‰¾è¿æ¥ç¼“å­˜

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|----|----|
| `lookup.cache.max-rows` | `1000` | ç¼“å­˜æœ€å¤§è¡Œæ•° |
| `lookup.cache.ttl` | `5min` | ç¼“å­˜ç”Ÿå­˜æ—¶é—´ |
| `lookup.max-retries` | `3` | æœ€å¤§é‡è¯•æ¬¡æ•° |

```properties
lookup.cache.max-rows = 1000        # ç¼“å­˜æœ€å¤§è¡Œæ•°
lookup.cache.ttl = 5min            # ç¼“å­˜ç”Ÿå­˜æ—¶é—´
lookup.max-retries = 3             # æœ€å¤§é‡è¯•æ¬¡æ•°
```

### 2ï¸âƒ£ æ£€æŸ¥ç‚¹é…ç½®

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|----|----|
| `execution.checkpointing.interval` | `10s` | æ£€æŸ¥ç‚¹é—´éš” |
| `execution.checkpointing.mode` | `EXACTLY_ONCE` | ä¸€è‡´æ€§ä¿è¯ |
| `execution.checkpointing.timeout` | `60s` | æ£€æŸ¥ç‚¹è¶…æ—¶ |

```properties
execution.checkpointing.interval = 10s      # æ£€æŸ¥ç‚¹é—´éš”
execution.checkpointing.mode = EXACTLY_ONCE # ä¸€è‡´æ€§ä¿è¯
execution.checkpointing.timeout = 60s       # æ£€æŸ¥ç‚¹è¶…æ—¶
```

### 3ï¸âƒ£ å¹¶è¡Œåº¦è®¾ç½®

```python
env.set_parallelism(1)  # æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´
```

> ğŸ’¡ **æç¤º**: å¹¶è¡Œåº¦è®¾ç½®éœ€è¦æ ¹æ®æ•°æ®é‡ã€æœºå™¨èµ„æºå’Œå»¶è¿Ÿè¦æ±‚è¿›è¡Œè°ƒæ•´

---

## ğŸ“Š ç›‘æ§ä¸è°ƒè¯•

### 1ï¸âƒ£ Print Sink è°ƒè¯•
```sql
CREATE TABLE lookup_result_print (
    -- å­—æ®µå®šä¹‰
) WITH (
    'connector' = 'print',
    'print-identifier' = 'Kafka-MySQL-Lookup'
)
```

### 2ï¸âƒ£ æ•°æ®è´¨é‡ç›‘æ§

| ç›‘æ§é¡¹ | éªŒè¯è§„åˆ™ | ç›®çš„ |
|--------|----------|------|
| ğŸ“ **ç»çº¬åº¦èŒƒå›´** | latitude: [-90, 90]<br/>longitude: [-180, 180] | åœ°ç†ä½ç½®æœ‰æ•ˆæ€§ |
| ğŸ“ **æµ‹é‡å€¼** | metric >= 0 | ä¸šåŠ¡é€»è¾‘æœ‰æ•ˆæ€§ |
| ğŸ¯ **æŸ¥æ‰¾è¿æ¥å‘½ä¸­ç‡** | ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡ | æ€§èƒ½ä¼˜åŒ–æŒ‡æ ‡ |

---

## ğŸš€ éƒ¨ç½²æ–¹å¼

### 1ï¸âƒ£ é›†ç¾¤éƒ¨ç½²
```bash
flink run -py mysql/mysql_lookup_metadata.py -pyfs . -D pipeline.name="MysqlLookupMetadataJob"
```

### 2ï¸âƒ£ æœ¬åœ°è°ƒè¯•
```bash
python mysql/mysql_lookup_metadata.py
```

> âš ï¸ **æ³¨æ„**: æœ¬åœ°è¿è¡Œéœ€è¦æ·»åŠ  `result.wait()` ä¿æŒä»»åŠ¡æŒç»­è¿è¡Œã€‚

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1ï¸âƒ£ æ•°æ®è´¨é‡ä¿è¯

| å®è·µé¡¹ | å…·ä½“æªæ–½ | é¢„æœŸæ•ˆæœ |
|--------|----------|----------|
| ğŸ” **è¾“å…¥æ•°æ®éªŒè¯** | å­—æ®µå®Œæ•´æ€§ã€æ•°æ®ç±»å‹æ£€æŸ¥ | æé«˜æ•°æ®å‡†ç¡®æ€§ |
| ğŸ’¾ **ç¼“å­˜ç­–ç•¥** | åˆç†è®¾ç½®ç¼“å­˜å¤§å°å’ŒTTL | å¹³è¡¡æ€§èƒ½ä¸æ–°é²œåº¦ |
| ğŸ“ˆ **æ€§èƒ½ç›‘æ§** | ç›‘æ§æŸ¥æ‰¾è¿æ¥å‘½ä¸­ç‡å’Œå»¶è¿Ÿ | åŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜ |

### 2ï¸âƒ£ å®¹é”™è®¾è®¡

| å®¹é”™æœºåˆ¶ | é…ç½®è¦ç‚¹ | å®¹é”™æ•ˆæœ |
|----------|----------|----------|
| âš¡ **æ£€æŸ¥ç‚¹æœºåˆ¶** | 10ç§’é—´éš”ï¼ŒEXACTLY_ONCEæ¨¡å¼ | æ•…éšœè‡ªåŠ¨æ¢å¤ |
| ğŸ”„ **é‡è¯•ç­–ç•¥** | æœ€å¤§3æ¬¡é‡è¯•ï¼ŒæŒ‡æ•°é€€é¿ | å¤„ç†ä¸´æ—¶ç½‘ç»œé—®é¢˜ |
| ğŸ›¡ï¸ **é™çº§å¤„ç†** | ç»´åº¦è¡¨ä¸å¯ç”¨æ—¶ä½¿ç”¨é»˜è®¤å€¼ | ä¿è¯æœåŠ¡å¯ç”¨æ€§ |

### 3ï¸âƒ£ æ€§èƒ½è°ƒä¼˜

| è°ƒä¼˜ç»´åº¦ | ä¼˜åŒ–ç­–ç•¥ | æ€§èƒ½æå‡ |
|----------|----------|----------|
| ğŸš€ **å¹¶è¡Œåº¦** | æ ¹æ®æ•°æ®é‡å’Œèµ„æºåŠ¨æ€è°ƒæ•´ | æé«˜å¤„ç†ååé‡ |
| ğŸ“¦ **æ‰¹å¤„ç†** | ä¼˜åŒ–æ‰¹å¤§å°å’Œç¼“å­˜é…ç½® | å‡å°‘ç½‘ç»œå¼€é”€ |
| ğŸ“Š **ç›‘æ§å‘Šè­¦** | è®¾ç½®èƒŒå‹å’Œå»¶è¿Ÿé˜ˆå€¼ | åŠæ—¶æ€§èƒ½è°ƒä¼˜ |

---

## ğŸŒŸ åº”ç”¨åœºæ™¯

| åœºæ™¯ | åº”ç”¨æè¿° | æŠ€æœ¯ä¼˜åŠ¿ |
|------|----------|----------|
| ğŸ­ **IoT è®¾å¤‡ç›‘æ§** | å®æ—¶ä¸°å¯Œè®¾å¤‡ä½ç½®å’ŒçŠ¶æ€ä¿¡æ¯ | æ¯«ç§’çº§å“åº”ï¼Œæ”¯æŒæµ·é‡è®¾å¤‡ |
| ğŸ‘¥ **ç”¨æˆ·è¡Œä¸ºåˆ†æ** | å…³è”ç”¨æˆ·åŸºç¡€ä¿¡æ¯å’Œè¡Œä¸ºæ•°æ® | å®æ—¶ä¸ªæ€§åŒ–æ¨è |
| ğŸ’° **é‡‘èé£æ§** | å®æ—¶å…³è”äº¤æ˜“å’Œå®¢æˆ·ä¿¡æ¯ | ç§’çº§é£é™©è¯†åˆ« |
| ğŸ“¦ **ç‰©æµè¿½è¸ª** | ä¸°å¯ŒåŒ…è£¹å’Œè¿è¾“ä¿¡æ¯ | å…¨é“¾è·¯å®æ—¶å¯è§†åŒ– |

---

## ğŸ‰ æ€»ç»“

æœ¬æ–‡å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ PyFlink å®ç° Kafka + MySQL çš„æŸ¥æ‰¾è¿æ¥ï¼Œå®ç°äº†å®æ—¶æ•°æ®ä¸°å¯Œçš„å®Œæ•´æ–¹æ¡ˆã€‚é€šè¿‡åˆç†çš„é…ç½®å’Œä¼˜åŒ–ï¼Œèƒ½å¤Ÿåœ¨ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„åŒæ—¶ï¼Œå®ç°é«˜æ€§èƒ½çš„å®æ—¶æ•°æ®å¤„ç†ã€‚

### ğŸ† å…³é”®æ”¶ç›Š

| æ”¶ç›Šç»´åº¦ | å…·ä½“è¡¨ç° | ä¸šåŠ¡ä»·å€¼ |
|----------|----------|----------|
| âš¡ **å®æ—¶æ€§** | æ¯«ç§’çº§æ•°æ®å¤„ç†å»¶è¿Ÿ | æ”¯æŒå®æ—¶å†³ç­– |
| ğŸ¯ **ä¸€è‡´æ€§** | EXACTLY_ONCE è¯­ä¹‰ä¿è¯ | æ•°æ®å‡†ç¡®å¯é  |
| ğŸ“ˆ **å¯æ‰©å±•æ€§** | æ”¯æŒæ°´å¹³æ‰©å±• | é€‚åº”ä¸šåŠ¡å¢é•¿ |
| ğŸ›¡ï¸ **å®¹é”™æ€§** | è‡ªåŠ¨æ•…éšœæ¢å¤æœºåˆ¶ | æé«˜æœåŠ¡ç¨³å®šæ€§ |

### ğŸš€ é€‚ç”¨æ€§

è¿™ç§æ¶æ„ä¸ºå®æ—¶æ•°æ®ä¸°å¯Œæä¾›äº†**å¯é ã€é«˜æ•ˆ**çš„è§£å†³æ–¹æ¡ˆï¼Œç‰¹åˆ«é€‚ç”¨äºï¼š

- ğŸ“Š **æ•°æ®é‡å¤§**ï¼šæ”¯æŒæ¯ç§’ç™¾ä¸‡çº§æ•°æ®å¤„ç†
- â±ï¸ **å»¶è¿Ÿæ•æ„Ÿ**ï¼šæ¯«ç§’çº§ç«¯åˆ°ç«¯å»¶è¿Ÿ
- ğŸ”„ **å˜åŒ–é¢‘ç¹**ï¼šæ”¯æŒåŠ¨æ€é…ç½®å’Œæ‰©ç¼©å®¹
- ğŸ¯ **è´¨é‡è¦æ±‚é«˜**ï¼šEXACTLY_ONCEè¯­ä¹‰ä¿è¯

---

> ğŸ’¡ **ä¸‹ä¸€æ­¥**: å¯ä»¥åŸºäºæ­¤æ¶æ„æ‰©å±•æ›´å¤šæ•°æ®æºå’Œ Sinkï¼Œæ„å»ºå®Œæ•´çš„å®æ—¶æ•°æ®æ¹–è§£å†³æ–¹æ¡ˆã€‚ 