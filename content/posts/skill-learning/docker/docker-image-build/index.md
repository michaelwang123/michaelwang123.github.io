---
title: "ğŸ³ Dockerå¤šæ¶æ„é•œåƒæ„å»ºæœ€ä½³å®è·µ"
description: "æ·±å…¥è§£æDockerè·¨å¹³å°é•œåƒæ„å»ºæŠ€æœ¯ï¼Œæ”¯æŒWindowsã€Macã€Linuxå¤šæ¶æ„éƒ¨ç½²"
date: 2024-06-23T10:00:00+08:00
tags: ["Docker", "Multi-Architecture", "CI/CD", "DevOps"]
categories: ["å®¹å™¨æŠ€æœ¯", "DevOpså®è·µ"]
weight: 2
ShowToc: true
TocOpen: true
---

ä¸éœ€è¦åˆ†åˆ«æ„å»º Windows å’Œ Mac ä¸“ç”¨çš„ Docker é•œåƒã€‚Docker çš„è·¨å¹³å°ç‰¹æ€§ä¸»è¦ä¾èµ–äº **CPU æ¶æ„**ï¼ˆå¦‚ AMD64ã€ARM64ï¼‰çš„å…¼å®¹æ€§ï¼Œè€Œéæ“ä½œç³»ç»Ÿç±»å‹ã€‚ä»¥ä¸‹æ˜¯å…·ä½“å®ç°æ–¹æ¡ˆå’Œæ³¨æ„äº‹é¡¹ï¼š

---

### ä¸€ã€è·¨å¹³å°é•œåƒçš„æ ¸å¿ƒé€»è¾‘
1. **ä»¥æ¶æ„ä¸ºä¸­å¿ƒï¼Œè€Œéæ“ä½œç³»ç»Ÿ**  
   - Windows å’Œ Mac ç”¨æˆ·é€šè¿‡ Docker Desktop è¿è¡Œæ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯åŸºäº Linux å®¹å™¨ï¼ˆé€šè¿‡è™šæ‹ŸåŒ–æŠ€æœ¯å®ç°ï¼‰ã€‚å› æ­¤é•œåƒéœ€å…¼å®¹ **Linux ç³»ç»Ÿ**çš„ CPU æ¶æ„ï¼š
     - **Windows**ï¼šé€šå¸¸è¿è¡Œåœ¨ `linux/amd64` æ¶æ„ï¼ˆä¼ ç»Ÿ Intel/AMD CPUï¼‰ã€‚
     - **Mac**ï¼šIntel èŠ¯ç‰‡çš„ Mac å¯¹åº” `linux/amd64`ï¼ŒApple Siliconï¼ˆM1/M2ï¼‰å¯¹åº” `linux/arm64`ã€‚
   - ä½ åªéœ€æ„å»ºæ”¯æŒ `linux/amd64` å’Œ `linux/arm64` çš„å¤šæ¶æ„é•œåƒï¼Œå³å¯è¦†ç›–ä¸¤ç±»ç”¨æˆ·éœ€æ±‚ã€‚

2. **Docker çš„è‡ªåŠ¨åŒ¹é…æœºåˆ¶**  
   é€šè¿‡ **Manifest List**ï¼ˆé•œåƒæ¸…å•ï¼‰æŠ€æœ¯ï¼Œå°†ä¸åŒæ¶æ„çš„é•œåƒåˆå¹¶ä¸ºå•ä¸€æ ‡ç­¾ï¼ˆå¦‚ `myapp:latest`ï¼‰ã€‚ç”¨æˆ·æ‰§è¡Œ `docker pull` æ—¶ï¼ŒDocker ä¼šè‡ªåŠ¨æ‹‰å–ä¸å…¶æ¶æ„åŒ¹é…çš„é•œåƒç‰ˆæœ¬ã€‚

---

### äºŒã€æ„å»ºå¤šæ¶æ„é•œåƒçš„æ–¹æ³•
#### æ–¹æ³• 1ï¼šä½¿ç”¨ Docker Buildxï¼ˆæ¨èï¼‰
```bash
# å¯ç”¨ Buildx å¹¶åˆ›å»ºå¤šå¹³å°æ„å»ºå™¨
docker buildx create --name multiarch --use
docker buildx inspect --bootstrap

# æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒï¼ˆç¤ºä¾‹ï¼‰
docker buildx build \
  --platform linux/amd64,linux/arm64 \  # ç›®æ ‡æ¶æ„
  -t yourusername/myapp:latest \        # é•œåƒæ ‡ç­¾
  --push .                             # ç›´æ¥æ¨é€åˆ° Docker Hub
```
- **åŸç†**ï¼šä¸€æ¬¡æ€§ç¼–è¯‘æ‰€æœ‰ç›®æ ‡æ¶æ„çš„é•œåƒï¼Œå¹¶ç”Ÿæˆ Manifest Listã€‚
- **ä¼˜åŠ¿**ï¼šæ— éœ€æ‰‹åŠ¨ç®¡ç†å¤šä¸ªæ ‡ç­¾ï¼Œç”¨æˆ·åªéœ€æ‹‰å–ä¸€ä¸ªé•œåƒåã€‚

#### æ–¹æ³• 2ï¼šæ¡ä»¶åŒ– Dockerfileï¼ˆå¤„ç†æ¶æ„å·®å¼‚ï¼‰
è‹¥é•œåƒå†…å®¹å› æ¶æ„ä¸åŒéœ€å·®å¼‚åŒ–å¤„ç†ï¼ˆå¦‚å®‰è£…ä¸åŒä¾èµ–åŒ…ï¼‰ï¼Œå¯åœ¨ Dockerfile ä¸­é€šè¿‡ `TARGETARCH` å˜é‡åŠ¨æ€é€‚é…ï¼š
```dockerfile
FROM --platform=$TARGETPLATFORM alpine:latest  # åŠ¨æ€é€‰æ‹©åŸºç¡€é•œåƒæ¶æ„
ARG TARGETARCH

# æ ¹æ®æ¶æ„å®‰è£…å¯¹åº”ä¾èµ–
RUN if [ "$TARGETARCH" = "amd64" ]; then \
      echo "Installing x86 packages..."; \
    elif [ "$TARGETARCH" = "arm64" ]; then \
      echo "Installing ARM packages..."; \
    fi
```
- **åº”ç”¨åœºæ™¯**ï¼šéœ€è¦ä¸ºä¸åŒæ¶æ„é¢„ç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶æˆ–å®‰è£…ä¸“ç”¨åº“æ—¶ã€‚

---

### ä¸‰ã€éªŒè¯ä¸æµ‹è¯•
1. **æ£€æŸ¥é•œåƒæ¶æ„ä¿¡æ¯**  
   ```bash
   docker buildx imagetools inspect yourusername/myapp:latest
   ```
   è¾“å‡ºåº”åŒ…å« `linux/amd64` å’Œ `linux/arm64` çš„é•œåƒå±‚ä¿¡æ¯ã€‚

2. **æ¨¡æ‹Ÿè·¨å¹³å°è¿è¡Œ**  
   ```bash
   # åœ¨ AMD64 æœºå™¨ä¸Šæµ‹è¯• ARM64 é•œåƒï¼ˆéœ€ QEMU æ¨¡æ‹Ÿï¼‰
   docker run --rm --platform linux/arm64 yourusername/myapp:latest uname -m
   # è¾“å‡ºåº”ä¸ºï¼šaarch64
   ```

---

### å››ã€æ³¨æ„äº‹é¡¹
1. **åŸºç¡€é•œåƒå…¼å®¹æ€§**  
   ç¡®ä¿åŸºç¡€é•œåƒï¼ˆå¦‚ `alpine:latest`ï¼‰æœ¬èº«æ”¯æŒå¤šæ¶æ„ã€‚å¯é€šè¿‡ `docker manifest inspect` éªŒè¯ã€‚

2. **æ€§èƒ½ä¼˜åŒ–**  
   - ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼ˆMulti-stage Buildsï¼‰å‡å°‘é•œåƒä½“ç§¯ã€‚
   - é¿å…åœ¨é•œåƒä¸­åŒ…å«ä¸å¿…è¦çš„å¹³å°ç›¸å…³æ–‡ä»¶ã€‚

3. **ç§æœ‰ä»“åº“æ”¯æŒ**  
   è‹¥ä½¿ç”¨ç§æœ‰ä»“åº“ï¼ˆå¦‚ Harborï¼‰ï¼Œéœ€ç¡®ä¿å…¶æ”¯æŒ Manifest List æ ¼å¼ã€‚

---

### äº”ã€æ€»ç»“
- **æ— éœ€ä¸º Windows/Mac åˆ†åˆ«æ„å»ºé•œåƒ**ï¼Œåªéœ€é€šè¿‡ `docker buildx` ç”Ÿæˆæ”¯æŒ `linux/amd64` å’Œ `linux/arm64` çš„å¤šæ¶æ„é•œåƒã€‚
- ç”¨æˆ·é€šè¿‡ `docker pull yourusername/myapp:latest` å³å¯è‡ªåŠ¨è·å–é€‚é…å…¶ CPU æ¶æ„çš„ç‰ˆæœ¬ã€‚
- è‹¥éœ€å¤„ç†æ¶æ„å·®å¼‚ï¼Œå¯é€šè¿‡ Dockerfile çš„ `TARGETARCH` å˜é‡åŠ¨æ€é€‚é…ä¾èµ–å®‰è£…æµç¨‹ã€‚